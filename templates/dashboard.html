<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kairos Relatórios</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="#" class="navbar-brand">Kairos Relatórios</a>
            <div class="nav-links">
                <span>Olá, {{ session['username'] }}</span>
                {% if is_admin %}
                <a href="{{ url_for('admin_users') }}">Administração</a>
                {% endif %}
                <a href="{{ url_for('logout') }}">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Filters Section -->
        <div class="card">
            <h3>Filtros</h3>
            <div class="filters">
                <div class="filter-group">
                    <label for="start_date">Data Início</label>
                    <input type="date" id="start_date" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="end_date">Data Fim</label>
                    <input type="date" id="end_date" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="matricula">Matrícula (Opcional)</label>
                    <input type="text" id="matricula" class="form-control" placeholder="Todas">
                </div>
                <button id="btn-search" class="btn btn-primary" style="width: auto;">Pesquisar</button>
            </div>
            <div id="error-msg" class="alert alert-danger" style="display: none;"></div>
        </div>

        <!-- Results Section -->
        <div class="card" id="results-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Resultados</h3>
                <button id="btn-export" class="btn btn-success" style="width: auto;">Exportar Excel</button>
            </div>

            <div class="loading" id="loading">Carregando dados...</div>

            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Matrícula</th>
                            <th>Nome</th>
                            <th>Relógio ID</th>
                            <th>NumeroSerieRep</th>
                            <th>Data</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        const itemsPerPage = 10;
        let currentPage = 1;

        document.getElementById('btn-search').addEventListener('click', async () => {
            const startDateInput = document.getElementById('start_date').value;
            const endDateInput = document.getElementById('end_date').value;
            const matriculaInput = document.getElementById('matricula').value;
            const errorMsg = document.getElementById('error-msg');
            const loading = document.getElementById('loading');
            const resultsCard = document.getElementById('results-card');
            const tbody = document.querySelector('#data-table tbody');

            errorMsg.style.display = 'none';

            if (!startDateInput || !endDateInput) {
                errorMsg.textContent = 'Por favor, selecione as datas de início e fim.';
                errorMsg.style.display = 'block';
                return;
            }

            // Format dates to DD-MM-YYYY for API
            const formatDate = (dateStr) => {
                const [y, m, d] = dateStr.split('-');
                return `${d}-${m}-${y}`;
            };

            const payload = {
                start_date: formatDate(startDateInput),
                end_date: formatDate(endDateInput),
                matricula: matriculaInput
            };

            loading.style.display = 'block';
            resultsCard.style.display = 'block';
            tbody.innerHTML = ''; // Clear previous data

            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro na requisição');
                }

                currentData = result.data;
                currentPage = 1;
                renderTable();
                renderPagination();

            } catch (error) {
                errorMsg.textContent = error.message;
                errorMsg.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        document.getElementById('btn-export').addEventListener('click', async () => {
            if (currentData.length === 0) {
                alert('Sem dados para exportar.');
                return;
            }

            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ records: currentData })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'relatorio_ponto.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert('Erro ao exportar arquivo.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao exportar arquivo.');
            }
        });

        function renderTable() {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = currentData.slice(start, end);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Matricula}</td>
                    <td>${row.Nome || ''}</td>
                    <td>${row.RelogioID}</td>
                    <td>${row.NumeroSerieRep}</td>
                    <td>${row.DataFormatada}</td>
                    <td>${row.HoraFormatada}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(currentData.length / itemsPerPage);

            if (totalPages <= 1) return;

            const createButton = (text, page, isActive = false, isDisabled = false) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                if (isActive) btn.classList.add('active');
                if (isDisabled) btn.disabled = true;
                else {
                    btn.onclick = () => {
                        currentPage = page;
                        renderTable();
                        renderPagination();
                    };
                }
                return btn;
            };

            // Previous Button
            pagination.appendChild(createButton('Anterior', currentPage - 1, false, currentPage === 1));

            // Smart Pagination Logic
            const maxVisibleButtons = 5; // Number of buttons to show around current page

            let startPage, endPage;

            if (totalPages <= maxVisibleButtons + 2) {
                // If total pages is small, show all
                startPage = 1;
                endPage = totalPages;
            } else {
                // Logic for ellipses
                if (currentPage <= maxVisibleButtons - 2) {
                    startPage = 1;
                    endPage = maxVisibleButtons;
                } else if (currentPage + (maxVisibleButtons - 3) >= totalPages) {
                    startPage = totalPages - (maxVisibleButtons - 1);
                    endPage = totalPages;
                } else {
                    startPage = currentPage - 2;
                    endPage = currentPage + 2;
                }
            }

            // First Page + Ellipsis
            if (startPage > 1) {
                pagination.appendChild(createButton('1', 1));
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.alignSelf = 'center';
                    ellipsis.style.margin = '0 5px';
                    pagination.appendChild(ellipsis);
                }
            }

            // Page Numbers
            for (let i = startPage; i <= endPage; i++) {
                pagination.appendChild(createButton(i, i, i === currentPage));
            }

            // Last Page + Ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.alignSelf = 'center';
                    ellipsis.style.margin = '0 5px';
                    pagination.appendChild(ellipsis);
                }
                pagination.appendChild(createButton(totalPages, totalPages));
            }

            // Next Button
            pagination.appendChild(createButton('Próximo', currentPage + 1, false, currentPage === totalPages));
        }
    </script>
</body>

</html>